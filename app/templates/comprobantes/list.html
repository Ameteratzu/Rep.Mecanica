{% extends "base.html" %}

{% block content %}
<style>
.main-content {
  margin-top: 60px;
  margin-left: 200px; /* Ajusta si tu sidebar es diferente */
  padding: 2.5em 1.5em;
  background-color: white;
  min-height: calc(100vh - 60px);
  border-radius: 0.6em;
  box-shadow: 0 8px 32px rgba(50,50,50,0.04);
}
</style>

<div class="main-content container-lg">
  <h2 class="mb-4">Listado de Comprobantes</h2>
  <hr>

  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <div class="d-flex gap-2 mb-2 mb-md-0">
      <a href="{{ url_for('comprobantes.exportar_comprobantes_excel') }}" class="btn btn-success">
        <i class="fas fa-file-csv"></i> Exportar Excel
      </a>
      <!-- Botón para abrir el modal -->
      <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalNuevaBoleta">
        <i class="fas fa-plus"></i> Nueva Boleta
      </button>
    </div>
    <form class="d-flex align-items-center" method="get" action="{{ url_for('comprobantes.list_comprobantes') }}">
      <input type="text" name="search" class="form-control me-2"
             value="{{ search|default('') }}"
             placeholder="Cliente, Serie, Número, Total...">
      <button class="btn btn-primary" type="submit">Buscar</button>
    </form>
  </div>

  <table class="table table-striped table-bordered align-middle">
    <thead class="table-dark">
      <tr>
        <th>#</th>
        <th>Serie - Número</th>
        <th>Fecha</th>
        <th>Cliente</th>
        <th>Orden</th>
        <th>Subtotal</th>
        <th>IGV</th>
        <th>Total</th>
        <th>Pago</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody>
      {% if comprobantes %}
        {% for c in comprobantes %}
          <tr>
            <td>{{ c.id }}</td>
            <td>{{ c.serie }}-{{ "%08d"|format(c.numero) }}</td>
            <td>{{ c.fecha_emision.strftime('%d/%m/%Y') if c.fecha_emision else '-' }}</td>
            <td>
              {% if c.cliente %}
                {{ c.cliente.nombres }} {{ c.cliente.apellidos }}<br>
                <small>DNI: {{ c.cliente.documento }}</small>
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ c.orden_id or '-' }}</td>
            <td>S/ {{ '%.2f' % c.subtotal }}</td>
            <td>S/ {{ '%.2f' % c.igv }}</td>
            <td><strong>S/ {{ '%.2f' % c.total }}</strong></td>
            <td>{{ c.forma_pago or '-' }}</td>
            <td class="d-flex gap-1">
              <a href="{{ url_for('comprobantes.imprimir_comprobante', comprobante_id=c.id) }}" class="btn btn-info btn-sm">Ver</a>
              <!-- Botón para mostrar detalles -->
              <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="collapse" data-bs-target="#detalles{{ c.id }}" aria-expanded="false" aria-controls="detalles{{ c.id }}">
                <i class="fas fa-chevron-down"></i>
              </button>
            </td>
          </tr>
          <tr class="collapse" id="detalles{{ c.id }}">
            <td colspan="10" class="bg-light">
              <div class="p-2">
                <strong>Detalle de la venta:</strong>
                {% if c.detalle %}
                  <table class="table table-sm table-bordered mt-2 mb-0">
                    <thead>
                      <tr>
                        <th>Descripción</th>
                        <th>Cantidad</th>
                        <th>Precio unitario</th>
                        <th>Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for d in c.detalle %}
                      <tr>
                        <td>{{ d.descripcion }}</td>
                        <td>{{ d.cantidad }}</td>
                        <td>S/ {{ '%.2f' % d.precio_unitario }}</td>
                        <td>S/ {{ '%.2f' % d.total }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  <span class="text-muted">Sin detalles registrados.</span>
                {% endif %}
              </div>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="10" class="text-center">No hay comprobantes registrados.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- MODAL: Nueva Boleta -->
<div class="modal fade" id="modalNuevaBoleta" tabindex="-1" aria-labelledby="modalNuevaBoletaLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <form class="modal-content" method="POST" action="{{ url_for('comprobantes.nueva_boleta') }}">
      <div class="modal-header">
        <h5 class="modal-title" id="modalNuevaBoletaLabel"><i class="fas fa-file-invoice"></i> Nueva Boleta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <!-- Cliente existente -->
          <div class="col-md-6">
            <label for="cliente_id" class="form-label">Cliente existente</label>
            <select name="cliente_id" id="cliente_id" class="form-select">
              <option value="">Selecciona un cliente...</option>
              {% for c in clientes %}
                <option value="{{ c.id }}">
                  {{ c.nombres }} {{ c.apellidos }} - {{ c.documento }}
                </option>
              {% endfor %}
            </select>
            <div class="form-text">
              ¿No existe? <a href="#" onclick="mostrarNuevoCliente(event)">Crear nuevo cliente</a>
            </div>
          </div>
        </div>
        <div id="nuevoClienteCampos" class="row g-3 mt-2" style="display: none;">
          <!-- Datos nuevo cliente -->
          <h6>Datos del nuevo cliente</h6>
          <div class="col-md-6">
            <label class="form-label">Nombres</label>
            <input type="text" name="nombres" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Apellidos</label>
            <input type="text" name="apellidos" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Tipo Documento</label>
            <select name="tipo_documento" class="form-select">
              <option value="DNI">DNI</option>
              <option value="CE">CE</option>
              <option value="RUC">RUC</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">N° Documento</label>
            <input type="text" name="documento" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Celular</label>
            <input type="text" name="celular" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Correo</label>
            <input type="email" name="correo" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Dirección</label>
            <input type="text" name="direccion" class="form-control">
          </div>
        </div>
        <hr class="my-3">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Fecha de emisión</label>
            <input type="date" name="fecha_emision" class="form-control" value="{{ hoy }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Forma de pago</label>
            <select name="forma_pago" class="form-select">
              <option value="Efectivo">Efectivo</option>
              <option value="Transferencia">Transferencia</option>
              <option value="Yape">Yape</option>
              <option value="Plin">Plin</option>
              <option value="Tarjeta">Tarjeta</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Observaciones</label>
            <input type="text" name="observaciones" class="form-control">
          </div>
        </div>
        <hr class="my-3">
        <!-- Detalles de productos o servicios -->
        <div class="accordion" id="detallesVentaAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingDetalles">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetalles" aria-expanded="false" aria-controls="collapseDetalles">
                Detalles de la Venta (productos o servicios)
              </button>
            </h2>
            <div id="collapseDetalles" class="accordion-collapse collapse" aria-labelledby="headingDetalles" data-bs-parent="#detallesVentaAccordion">
              <div class="accordion-body">
                <table class="table table-bordered align-middle" id="tablaDetalleBoleta">
                  <thead>
                    <tr>
                      <th>Descripción</th>
                      <th>Cantidad</th>
                      <th>Precio unitario</th>
                      <th>Total</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><input type="text" name="descripcion[]" class="form-control"></td>
                      <td><input type="number" min="1" name="cantidad[]" class="form-control" value="1"></td>
                      <td><input type="number" min="0" step="0.01" name="precio_unitario[]" class="form-control" value="0.00"></td>
                      <td><input type="number" name="total_detalle[]" class="form-control" readonly></td>
                      <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFilaDetalle(this)"><i class="fas fa-trash"></i></button></td>
                    </tr>
                  </tbody>
                </table>
                <button type="button" class="btn btn-secondary" onclick="agregarFilaDetalle()"><i class="fas fa-plus"></i> Agregar fila</button>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-3 text-end">
          <label class="fw-bold">Total (S/)</label>
          <input type="number" name="total" id="totalBoletaInput" class="form-control fw-bold" style="width: 200px; display: inline-block;" step="0.01" value="0.00" readonly>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="submit" class="btn btn-success">Guardar Boleta</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

<!-- SCRIPT para agregar más filas de detalle -->
<script>
function mostrarNuevoCliente(e) {
  e.preventDefault();
  document.getElementById('nuevoClienteCampos').style.display = '';
  document.getElementById('cliente_id').value = '';
}

// Calcula totales automáticamente
function calcularTotales() {
  let total = 0;
  document.querySelectorAll("#tablaDetalleBoleta tbody tr").forEach(row => {
    let cantidad = parseFloat(row.querySelector('input[name="cantidad[]"]').value) || 0;
    let precio = parseFloat(row.querySelector('input[name="precio_unitario[]"]').value) || 0;
    let totalFila = cantidad * precio;
    row.querySelector('input[name="total_detalle[]"]').value = totalFila.toFixed(2);
    total += totalFila;
  });
  document.getElementById('totalBoletaInput').value = total.toFixed(2);
}
function agregarFilaDetalle() {
  const tbody = document.querySelector('#tablaDetalleBoleta tbody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td><input type="text" name="descripcion[]" class="form-control"></td>
    <td><input type="number" min="1" name="cantidad[]" class="form-control" value="1"></td>
    <td><input type="number" min="0" step="0.01" name="precio_unitario[]" class="form-control" value="0.00"></td>
    <td><input type="number" name="total_detalle[]" class="form-control" readonly></td>
    <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFilaDetalle(this)"><i class="fas fa-trash"></i></button></td>
  `;
  tbody.appendChild(row);
  row.querySelectorAll('input').forEach(inp => inp.addEventListener('input', calcularTotales));
}
function eliminarFilaDetalle(btn) {
  btn.closest('tr').remove();
  calcularTotales();
}
// Listeners para recalcular totales en inputs
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('#tablaDetalleBoleta input').forEach(inp => {
    inp.addEventListener('input', calcularTotales);
  });
  calcularTotales();
});
</script>
