<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}Gestión de Clientes – TECMECH{% endblock %}</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- FontAwesome para iconos -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-pM1Wmj4dzuCE9Ux+IEKk+3Dp+9zgHLA5y1Kq+BcsH3cItSiPW1kq3RS+T14nWgpZK/Ya+oYvQz0txIx9Xg8xBg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    /* HEADER FIJO */
    .main-header {
      position: fixed; top: 0; left: 0; right: 0; height: 60px;
      background-color: #194989; color: white;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; z-index: 1000;
    }
    .main-header .logo { font-size: 1.5rem; font-weight: bold; }
    .main-header .user-info { display: flex; align-items: center; gap: 10px; }
    .main-header .user-info i { font-size: 1.5rem; }

    /* SIDEBAR FIJO */
    .sidebar {
      position: fixed; top: 60px; bottom: 0; left: 0; width: 200px;
      background-color: #194989; padding-top: 20px; overflow-y: auto;
    }
    .sidebar .nav-link {
      color: #adb5bd; border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .sidebar .nav-link:hover { background-color: white; color: #000 !important; }
    .sidebar .nav-link.active {
      background-color: white; color: #194989 !important; font-weight: bold;
    }

    /* CONTENIDO PRINCIPAL */
    .main-content {
      margin-top: 60px;
      margin-left: 200px;
      padding: 2.5em;
      background-color: #f8f9fa;
      min-height: calc(100vh - 60px);
    }

    /* BOTÓN CERRAR SESIÓN */
    .btn-logout {
      position: fixed; bottom: 20px; left: 20px;
      border-radius: 50%; background-color: #dc3545; color: #fff;
      padding: 0.5rem 0.7rem; z-index: 1000; text-decoration: none;
      display: flex; align-items: center; justify-content: center;
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="main-header">
    <div class="logo">TECMECH</div>
    <div class="user-info">
      <strong>{{ current_user.email }}</strong>
      <i class="fas fa-user-circle"></i>
    </div>
  </header>

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <h5 class="px-3 text-white">Administrador</h5>
    <ul class="nav flex-column">
      <li class="nav-item">
        <a href="{{ url_for('main.dashboard') }}"
           class="nav-link {% if request.endpoint == 'main.dashboard' %}active{% endif %}">
          Inicio
        </a>
      </li>
      <li class="nav-item">
        <a href="{{ url_for('orders.list_orders') }}"
           class="nav-link {% if request.endpoint.startswith('orders.') %}active{% endif %}">
          Órdenes
        </a>
      </li>
      <li class="nav-item">
        <a href="{{ url_for('receipts.list_receipts') }}"
           class="nav-link {% if request.endpoint == 'receipts.list_receipts' %}active{% endif %}">
          Comprobantes
        </a>
      </li>
      <li class="nav-item">
        <a href="{{ url_for('products.list_products') }}"
           class="nav-link {% if request.endpoint.startswith('products.') %}active{% endif %}">
          Productos
        </a>
      </li>
      <li class="nav-item">
        <a href="{{ url_for('main.lista_clientes') }}"
           class="nav-link {% if request.endpoint == 'main.lista_clientes' %}active{% endif %}">
          Clientes
        </a>
      </li>
    </ul>

    <!-- Botón Cerrar Sesión fijo -->
    <a href="{{ url_for('main.logout') }}" class="btn btn-danger btn-logout mt-auto">
    <i class="fas fa-sign-out-alt"></i> Cerrar sesión
    </a>
  </nav>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="main-content">
    <h4>Listado de Clientes</h4>
    <hr>

    <div class="mb-3 d-flex gap-2">
      <a href="{{ url_for('main.exportar_clientes_excel') }}" class="btn btn-success">
        <i class="fas fa-file-csv"></i> Exportar Excel
      </a>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#clientModal">
        <i class="fas fa-plus"></i> Nuevo
      </button>
    </div>

    {% include 'includes/alerts.html' %}

    <table id="clientes-table" class="table table-hover table-striped">
      <thead class="table-dark">
        <tr>
          <th>Tipo Doc</th>
          <th>Nº Doc</th>
          <th>Nombre</th>
          <th>Apellidos</th>
          <th>Celular</th>
          <th>Estado</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody>
        {% for c in clientes %}
        <tr>
          <td>{{ c.tipo_documento }}</td>
          <td>{{ c.documento }}</td>
          <td>{{ c.nombres }}</td>
          <td>{{ c.apellidos }}</td>
          <td>{{ c.celular }}</td>
          <td>{{ 'Activo' if c.activo else 'Inactivo' }}</td>
          <td>
            <a href="{{ url_for('main.editar_cliente', cliente_id=c.id) }}"
               class="btn btn-sm btn-warning"><i class="fas fa-pen"></i></a>
            <form action="{{ url_for('main.eliminar_cliente', cliente_id=c.id) }}"
                  method="POST" class="d-inline" onsubmit="return confirmarEliminacion(event)">
              <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="text-center">No hay clientes registrados.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if pagination %}
    <nav aria-label="Paginación de clientes">
      <ul class="pagination">
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('main.lista_clientes', page=pagination.prev_num) }}">← Anterior</a>
        </li>
        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
          {% if page_num %}
          <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('main.lista_clientes', page=page_num) }}">{{ page_num }}</a>
          </li>
          {% endif %}
        {% endfor %}
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('main.lista_clientes', page=pagination.next_num) }}">Siguiente →</a>
        </li>
      </ul>
    </nav>
    {% endif %}

    <!-- Modal Crear/Editar Cliente -->
    <div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="clientModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content text-dark">
          <div class="modal-header">
            <h5 class="modal-title" id="clientModalLabel">Nuevo Cliente</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <form method="post" action="{{ url_for('main.nuevo_cliente') }}">
            <div class="modal-body">
              <!-- Aquí van los campos: tipo_documento, documento, nombres, apellidos, correo, direccion, ubigeo_id, celular, activo -->
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Tipo Documento</label>
                  <select name="tipoDocumento" class="form-select" required>
                    <option value="">Seleccione...</option>
                    <option value="DNI">DNI</option>
                    <option value="Carnet de Extranjería">Carnet de Extranjería</option>
                    <option value="Pasaporte">Pasaporte</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Nº Documento</label>
                  <input type="text" name="documento" class="form-control" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Celular</label>
                  <input type="text" name="celular" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Nombres</label>
                  <input type="text" name="nombres" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Apellidos</label>
                  <input type="text" name="apellidos" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Correo</label>
                  <input type="email" name="correo" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Dirección</label>
                  <input type="text" name="direccion" class="form-control">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Distrito (Ubigeo)</label>
                  <select name="ubigeo" class="form-select" required>
                    <option value="">Seleccione...</option>
                    {% for u in ubigeos %}
                    <option value="{{ u.id }}">{{ u.departamento }}/{{ u.provincia }}/{{ u.distrito }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Estado</label>
                  <select name="activo" class="form-select" required>
                    <option value="1">Activo</option>
                    <option value="0">Inactivo</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div>

  <!-- Scripts: jQuery, Bootstrap y SweetAlert2 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    function confirmarEliminacion(event) {
      event.preventDefault();
      Swal.fire({
        title: '¿Estás seguro?',
        text: "¡Este cliente será eliminado permanentemente!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          event.target.closest('form').submit();
        }
      });
    }
  </script>

</body>
</html>
