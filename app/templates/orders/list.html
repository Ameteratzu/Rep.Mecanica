{% extends "base.html" %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Listado de Órdenes</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#orderModal">
      Agregar Orden
    </button>
  </div>

  <table class="table table-hover">
    <thead>
      <tr>
        <th>ID</th><th>Cliente</th><th>Fecha</th><th>Estado</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for orden in orders %}
      <tr>
        <td>{{ orden.id }}</td>
        <td>{{ orden.cliente.nombres }} {{ orden.cliente.apellidos }}</td>
        <td>{{ orden.fecha.strftime('%Y-%m-%d') }}</td>
        <td>{{ orden.estado_orden.estado_orden }}</td>
        <td>
          <a href="{{ url_for('orders.edit_order', order_id=orden.id) }}"
             class="btn btn-sm btn-warning">Editar</a>
          <form action="{{ url_for('orders.delete_order', order_id=orden.id) }}"
                method="post" style="display:inline">
            <button type="submit"
                    class="btn btn-sm btn-danger"
                    onclick="return confirm('¿Eliminar esta orden?');">
              Eliminar
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Paginación -->
  <nav>
    <ul class="pagination">
      {% if pagination.has_prev %}
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('orders.list_orders', page=pagination.prev_num) }}">← Anterior</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">← Anterior</span></li>
      {% endif %}

      {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
        {% if p %}
          <li class="page-item {{ 'active' if p == pagination.page }}">
            <a class="page-link" href="{{ url_for('orders.list_orders', page=p) }}">{{ p }}</a>
          </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
      {% endfor %}

      {% if pagination.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('main.lista_clientes', page=pagination.next_num, search=search, estado=estado) }}">Siguiente →</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">Siguiente →</span></li>
      {% endif %}
    </ul>
  </nav>

  <!-- Modal Agregar Orden -->
  <div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header justify-content-center position-relative">
          <h5 class="modal-title text-center w-100">Agregar Orden de servicio</h5>
          <button type="button" class="btn-close position-absolute top-0 end-0 m-3"
                  data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <form method="post" action="{{ url_for('orders.create_order') }}">
          <div class="modal-body">
            <div class="row mb-4">
              <div class="col-md-4">
                <label class="form-label">Estado de Orden</label>
                <select name="estado_orden" class="form-select" required>
                  <option value="" disabled selected>Seleccione...</option>
                  {% for e in estados %}
                  <option value="{{ e.id }}">{{ e.estado_orden }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4 offset-md-4">
                <label class="form-label">N° Orden</label>
                <input type="text" name="nro_orden" class="form-control" required>
              </div>
            </div>

            <!-- Cliente -->
              <h6>Cliente:</h6>
              <div class="row mb-4">
                <div class="col-md-3">
                  <label class="form-label">Documento</label>
                  <div class="input-group">
                    <input type="text" name="cliente_id" class="form-control" placeholder="ID cliente" required>
                    <button class="btn btn-outline-secondary" type="button">
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Nombre</label>
                  <input type="text" class="form-control" disabled placeholder="Se autocompleta">
                </div>
                <div class="col-md-5">
                  <label class="form-label">Celular</label>
                  <input type="text" class="form-control" disabled placeholder="Se autocompleta">
                </div>
              </div>

            <!-- Automóvil -->
            <h6>Automóvil:</h6>
            <div class="row mb-4">
              <div class="col-md-3">
                <label class="form-label">Placa</label>
                <div class="input-group">
                  <input type="text" name="automovil_id" class="form-control" placeholder="ID auto" required>
                  <button class="btn btn-outline-secondary" type="button">
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Modelo</label>
                <input type="text" class="form-control" disabled placeholder="Se autocompleta">
              </div>
              <div class="col-md-5">
                <label class="form-label">Marca</label>
                <input type="text" class="form-control" disabled placeholder="Se autocompleta">
              </div>
            </div>

            <hr>

            <!-- Servicios -->
            <button type="button" class="btn btn-dark mb-2" id="addServiceBtn">Agregar servicio</button>
            <table class="table table-bordered mb-4" id="servicesTable">
              <thead class="table-light">
                <tr>
                  <th>Código</th><th>Descripción</th><th>Cantidad</th><th>Precio</th><th>Acción</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <!-- Repuestos -->
            <button type="button" class="btn btn-dark mb-2" id="addProductBtn">Agregar repuestos</button>
            <table class="table table-bordered" id="productsTable">
              <thead class="table-light">
                <tr>
                  <th>Código</th><th>Producto</th><th>Cantidad</th><th>Precio</th><th>Acción</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <!-- Totales -->
            <div class="d-flex justify-content-end gap-5 mt-4">
              <div>
                <div>Total Productos</div>
                <div>S/ <span id="totalProducts">0.00</span></div>
              </div>
              <div>
                <div>Total Servicios</div>
                <div>S/ <span id="totalServices">0.00</span></div>
              </div>
              <div class="fw-bold fs-5">
                Total de la Orden S/ <span id="grandTotal">0.00</span>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-success">Agregar Orden</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Script dinámico (igual que antes) -->
  <script>
    const addServiceBtn = document.getElementById("addServiceBtn"),
          servicesTbody = document.querySelector("#servicesTable tbody"),
          addProductBtn = document.getElementById("addProductBtn"),
          productsTbody = document.querySelector("#productsTable tbody");

    addServiceBtn.addEventListener("click", () => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <input type="hidden" name="servicio_id[]" value="1">
          SVC-001
        </td>
        <td>Cambio aceite</td>
        <td><input type="number" name="servicio_cantidad[]" value="1" min="1"
                   class="form-control form-control-sm"></td>
        <td>S/ <span class="service-price">80.00</span></td>
        <td><button type="button" class="btn btn-sm btn-danger remove-row">✕</button></td>
      `;
      servicesTbody.appendChild(tr);
      recalcTotals();
    });

    addProductBtn.addEventListener("click", () => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <input type="hidden" name="producto_id[]" value="2">
          PROD-002
        </td>
        <td>Filtro aire</td>
        <td><input type="number" name="producto_cantidad[]" value="1" min="1"
                   class="form-control form-control-sm"></td>
        <td>S/ <span class="product-price">45.50</span></td>
        <td><button type="button" class="btn btn-sm btn-danger remove-row">✕</button></td>
      `;
      productsTbody.appendChild(tr);
      recalcTotals();
    });

    document.addEventListener("click", e => {
      if (e.target.matches(".remove-row")) {
        e.target.closest("tr").remove();
        recalcTotals();
      }
    });

    document.addEventListener("input", e => {
      if (e.target.matches("input[name='servicio_cantidad[]'], input[name='producto_cantidad[]']")) {
        recalcTotals();
      }
    });

    function recalcTotals() {
      let totalS = 0, totalP = 0;
      document.querySelectorAll("#servicesTable tbody tr").forEach(tr => {
        const qty   = +tr.querySelector("input[name='servicio_cantidad[]']").value;
        const price = +tr.querySelector(".service-price").textContent;
        totalS += qty * price;
      });
      document.querySelectorAll("#productsTable tbody tr").forEach(tr => {
        const qty   = +tr.querySelector("input[name='producto_cantidad[]']").value;
        const price = +tr.querySelector(".product-price").textContent;
        totalP += qty * price;
      });
      document.getElementById("totalServices").textContent = totalS.toFixed(2);
      document.getElementById("totalProducts").textContent = totalP.toFixed(2);
      document.getElementById("grandTotal").textContent   = (totalS + totalP).toFixed(2);
    }
  </script>
{% endblock %}
